{% extends "base.html" %}

{% block custom_css %}
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='bootstrap-datetimepicker.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='bootstrap-toggle.min.css') }}">
{% endblock %}

{% block content %}

<h1>Due Date Changer</h1>

<div id="main_container" class="container">

	<div id="top_buttons" class="text-right">
		<button type="button" id="expand_all_btn" class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-plus"></span> Expand All</button>
		<button type="button" id="collapse_all_btn" class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-minus"></span> Collapse All</button>
	</div>

	<form id="assignments_form" action="{{ url_for('update_assignments', course_id=course.id) }}" method="post">

	{% include "assignment_list.html" %}

	<div class="row"><input class="btn btn-success pull-right" type="submit" value="Submit"></div>
	</form>
</div><!-- /main_container -->

<!-- Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" role="dialog" aria-labelledby="statusModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
			<button id="close_x" type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="statusModalLabel">Updating Assignments</h4>
			</div>
			<div id="status_content" class="modal-body text-center">
				<p class="status-perc">0%</p>
				<div class="progress">
					<div class="progress-bar progress-bar-info progress-bar-striped" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
						<span class="sr-only">0% Complete</span>
					</div>
				</div>
				<p class="status-msg">Not Started</p>
			</div>
			<div class="modal-footer">
				<button id="close_button" type="button" class="btn btn-danger" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span> Close</button>
			</div>
		</div>
	</div>
</div>

{% endblock %}

{% block custom_js %}
	<script type="text/javascript" src="{{ url_for('static', filename='moment.min.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='bootstrap-datetimepicker.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='bootstrap-toggle.min.js') }}"></script>
	<script type="text/javascript">
		var update_interval_id = null;

		// Due date datetime picker
		$('.picker-due').datetimepicker({useCurrent: false});

		// toggle all "more" buttons
		$('#collapse_all_btn').on('click', function() {
			$('.collapse').collapse('hide');
		});
		$('#expand_all_btn').on('click', function() {
			$('.collapse').collapse('show');
		});

		// toggle "more" button
		$('.collapse').on('shown.bs.collapse', function() {
			var more_button = $(this).closest('.row').find('.more-button');
			$(more_button).html('More Options <span class="dropup"><span class="caret"></span></span>');
			resizeFrame();
		});
		$('.collapse').on('hidden.bs.collapse', function() {
			var more_button = $(this).closest('.row').find('.more-button');
			$(more_button).html('More Options <span class="caret"></span>');
			resizeFrame();
		});

		// Link pickers
		$('.row').each(function() {
			// link available at - available until
			var unlock_at = $(this).find('.picker.unlock-at');
			var lock_at = $(this).find('.picker.lock-at');
			link_pickers(unlock_at, lock_at);

			// link show answers - hide answers
			var show_at = $(this).find('.picker.show-at');
			var hide_at = $(this).find('.picker.hide-at');
			link_pickers(show_at, hide_at);
		});

		function link_pickers(start, end) {
			$(start).datetimepicker({useCurrent: false});
			$(end).datetimepicker({useCurrent: false});

			$(start).on("dp.change", function(e) {
				$(end).data("DateTimePicker").minDate(e.date);
			});
			$(end).on("dp.change", function(e) {
				$(start).data("DateTimePicker").maxDate(e.date);
			});
		}

		// Initialize status modal
		$('#statusModal').modal({
			backdrop: 'static',
			show: false
		});

		// Disable enter key submitting form
		$(document).on("keypress", "form", function(event) {
			return event.keyCode != 13;
		});

		// Reload page after closing window
		// potential issues with failed requests
		$('#close_button').on('click', function(e) {
			location.reload();
		});

		// AJAX submit updates
		$('#assignments_form').on('submit', function(e) {
			e.preventDefault();

			$('#statusModal').modal('show');
			$('#close_button').prop('disabled', true);
			$('#close_x').hide();

			// TODO: only update assignments that are altered.

			var post_url = $(this).attr('action');

			$.ajax({
				type: "POST",
				url: post_url,
				data: $(this).serialize()
			})
			.done(function(data) {
				update_interval_id = setInterval(checkUpdate, 1000, data.update_assignments_job_url);
			});

		})

		function checkUpdate(job_url) {
			$.ajax({
				type: "GET",
				url: job_url
			})
			.done(function(data) {

				// If there is no data yet, skip
				if ($.isEmptyObject(data)) {
					return;
				}

				var percent = data["percent"];
				var update_div = $('#status_content')
				var prog_bar = update_div.find('.progress-bar');

				update_div.find(".status-perc").html(percent.toString() + "%");
				prog_bar.attr('aria-valuenow', percent);
				prog_bar.attr('style', 'width: ' + percent.toString() + "%;");
				prog_bar.find("span").text(percent.toString() + "% Complete");
				update_div.find('.status-msg').html(data['status_msg']);

				if (data["status"] == "failed") {
					prog_bar.addClass("progress-bar-danger");
					prog_bar.removeClass("progress-bar-info");
					clearInterval(update_interval_id);
					update_div.find(".status-msg").attr("style", "color: #f00;");
				}
				else if (data["status"] == "complete") {
					prog_bar.addClass("progress-bar-success");
					prog_bar.removeClass("progress-bar-info");
					clearInterval(update_interval_id);
					update_div.find(".status-msg").attr("style", "color: #000;");
				}
				$('#close_button').prop('disabled', false);

			})
			.fail(function(data) {
				var prog_bar = update_div.find('.progress-bar');

				prog_bar.addClass("progress-bar-danger");
				prog_bar.removeClass("progress-bar-info");

				clearInterval(update_interval_id);

				refresh_div.find(".status-msg").html("<span style=\"color: #f00;\">Failed</span>");
			});
		}

	// $('.collapse').collapse('show'); // TEMPORARY start expanded. Remove.

	</script>
{% endblock %}
